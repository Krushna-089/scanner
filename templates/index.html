<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Barcode Scanner</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body { background: #f5f5f5; padding: 20px; }
.card { border-radius: 12px; }
#videoContainer { display: none; margin-top: 10px; }
#scanBtn { font-size: 30px; }
#interactive video { width: 100% !important; height: auto !important; }
.barcode-btn { width: 100%; margin-top: 10px; }
</style>
</head>

<body>
<div class="container">

    <div class="text-center mb-4">
        <h2 class="fw-bold">Barcode Scanner</h2>
    </div>

    <div class="d-grid mb-4">
        <a href="/download_all" class="btn btn-primary btn-lg">Download All Barcodes (ZIP)</a>
    </div>

    <div class="card p-4 shadow-sm text-center">
        <h5>Scan Barcode</h5>
        <button id="scanBtn" class="btn btn-dark mt-2">üì∑</button>
        <div id="videoContainer">
            <div id="interactive" class="viewport"></div>
        </div>
    </div>

    <div id="resultBox" class="card p-4 shadow-sm mt-3" style="display:none;">
        <h5 class="mb-3">Item Details</h5>
        <p><strong>Name:</strong> <span id="name"></span></p>
        <p><strong>Code:</strong> <span id="code"></span></p>
        <p><strong>Quantity:</strong> <span id="qty"></span></p>
        <p><strong>Unit Price:</strong> <span id="price"></span></p>

        <a id="downloadLink" href="#">
            <button class="btn btn-warning barcode-btn">Download Barcode (ZIP)</button>
        </a>
    </div>

</div>

<script>
let isScanning = false;

document.getElementById("scanBtn").addEventListener("click", () => {
    if (!isScanning) startScanner();
});

async function startScanner() {
    isScanning = true;
    document.getElementById("videoContainer").style.display = "block";

    // Request camera access
    let stream;
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
    } catch (e) {
        alert("Camera permission denied!");
        console.error(e);
        return;
    }

    // Get back camera
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === "videoinput");
    let backCam = cams.find(d => d.label.toLowerCase().includes("back") || d.label.toLowerCase().includes("environment")) || cams[0];

    stream.getTracks().forEach(t => t.stop());
    console.log("Selected Camera:", backCam.label);

   Quagga.init({
    inputStream: {
        type: "LiveStream",
        target: document.querySelector("#interactive"),
        constraints: { deviceId: backCam.deviceId, width: 1280, height: 720 }
    },
    decoder: {
        readers: ["code_128_reader", "ean_reader", "code_39_reader"] // <-- fixed
    },
    locate: true,
    numOfWorkers: navigator.hardwareConcurrency || 4
}, err => {
    if (err) { console.error("Quagga init error:", err); return; }
    Quagga.start();
});


    // Debugging: log processed frames
    Quagga.onProcessed(result => {
        // console.log(result); // uncomment for full frame debug
    });

    Quagga.onDetected(result => {
        if (!result.codeResult) return;
        let code = result.codeResult.code;
        console.log("Detected barcode:", code);
        stopScanner();
        checkCode(code);
    });
}

function stopScanner() {
    isScanning = false;
    Quagga.stop();
    document.getElementById("videoContainer").style.display = "none";
}

function checkCode(code) {
    const formData = new FormData();
    formData.append("code", code);

    fetch("/fetch", { method: "POST", body: formData })
        .then(r => r.json())
        .then(data => {
            if (data.status === "success") {
                document.getElementById("resultBox").style.display = "block";
                document.getElementById("name").innerText = data.data.Name;
                document.getElementById("code").innerText = data.data.Code;
                document.getElementById("qty").innerText = data.data.Quantity;
                document.getElementById("price").innerText = data.data.UnitPrice;
                document.getElementById("downloadLink").href = "/download_single/" + data.data.Code;
            } else {
                alert("‚ùå Data Not Found");
            }
        });
}
</script>

</body>
</html>
