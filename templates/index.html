<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Barcode Scanner</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body { background: #f5f5f5; padding: 20px; }
.card { border-radius: 12px; }
#videoContainer { display: none; margin-top: 10px; }
#scanBtn { font-size: 30px; }
.barcode-btn { width: 100%; margin-top: 10px; }
.input-group-text { cursor: pointer; }
</style>
</head>

<body>
<div class="container">

    <div class="text-center mb-4">
        <h2 class="fw-bold">Barcode Scanner</h2>
    </div>

    <div class="d-grid mb-4">
        <a href="/download_all" class="btn btn-primary btn-lg">Download All Barcodes (ZIP)</a>
    </div>

    <div class="card p-4 shadow-sm text-center mb-4">
        <h5>Enter or Scan Barcode</h5>
        <div class="input-group mt-2 mb-2">
            <input id="barcodeInput" type="text" class="form-control" placeholder="Enter barcode manually">
            <span class="input-group-text" id="scanIcon">üì∑</span>
        </div>
        <button id="enterBtn" class="btn btn-success mb-2">Enter</button>
        <div id="videoContainer">
            <div id="interactive" class="viewport"></div>
        </div>
    </div>

    <div class="card p-4 shadow-sm mb-4">
        <h5 class="mb-3">Scanned Items</h5>
        <div class="table-responsive">
            <table class="table table-striped" id="dataTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Code</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Download</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Items will be appended here -->
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
let isScanning = false;
let scanInputField = document.getElementById("barcodeInput");
let videoContainer = document.getElementById("videoContainer");
let dataTableBody = document.querySelector("#dataTable tbody");
let rowCount = 0;

// Open camera on icon click
document.getElementById("scanIcon").addEventListener("click", () => {
    if (!isScanning) startScanner();
});

// Manual entry
document.getElementById("enterBtn").addEventListener("click", () => {
    let code = scanInputField.value.trim();
    if(code) checkCode(code);
});

// Enter key also triggers manual entry
scanInputField.addEventListener("keypress", (e) => {
    if(e.key === "Enter"){
        let code = scanInputField.value.trim();
        if(code) checkCode(code);
    }
});

async function startScanner() {
    isScanning = true;
    videoContainer.style.display = "block";

    let stream;
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
    } catch (e) {
        alert("Camera permission denied!");
        console.error(e);
        return;
    }

    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === "videoinput");
    let backCam = cams.find(d => d.label.toLowerCase().includes("back") || d.label.toLowerCase().includes("environment")) || cams[0];

    stream.getTracks().forEach(t => t.stop());
    console.log("Selected Camera:", backCam.label);

    Quagga.init({
        inputStream: {
            type: "LiveStream",
            target: document.querySelector("#interactive"),
            constraints: { deviceId: backCam.deviceId, width: 1280, height: 720 }
        },
        decoder: { readers: ["code_128_reader","ean_reader","code_39_reader"] },
        locate: true,
        numOfWorkers: navigator.hardwareConcurrency || 4
    }, err => {
        if(err){ console.error(err); return; }
        Quagga.start();
    });

    Quagga.onDetected(result => {
        if(!result.codeResult) return;
        let code = result.codeResult.code;
        stopScanner();
        scanInputField.value = code;
        checkCode(code);
    });
}

function stopScanner() {
    isScanning = false;
    Quagga.stop();
    videoContainer.style.display = "none";
}

function checkCode(code) {
    const formData = new FormData();
    formData.append("code", code);

    fetch("/fetch", { method: "POST", body: formData })
        .then(r => r.json())
        .then(data => {
            if(data.status === "success") {
                rowCount++;
                const item = data.data;
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${rowCount}</td>
                    <td>${item.Name}</td>
                    <td>${item.Code}</td>
                    <td>${item.Quantity}</td>
                    <td>${item.UnitPrice}</td>
                    <td>
                        <a href="/download_single/${item.Code}">
                            <button class="btn btn-warning btn-sm">Download</button>
                        </a>
                    </td>
                `;
                dataTableBody.appendChild(row);
                scanInputField.value = "";
            } else {
                alert("‚ùå Data Not Found or Invalid Barcode");
                scanInputField.value = "";
            }
        });
}
</script>

</body>
</html>
